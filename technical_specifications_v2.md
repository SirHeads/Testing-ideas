# Technical Specifications: Phoenix Hypervisor Network v2

This document provides the detailed technical specifications for the DNS and Firewall configurations as per the `remediation_plan_v2.md`.

## 1. DNS Configuration

The DNS service is centralized and runs on the **Proxmox Hypervisor (10.0.0.13)**. It is the single source of truth for the `internal.thinkheads.ai` domain. All VMs and LXCs are configured to use `10.0.0.13` as their primary nameserver.

The core principle is that **all service hostnames resolve to the Nginx Gateway's IP address (`10.0.0.153`)**. This directs all traffic to the single, secure entry point.

### DNS Records (Generated by `hypervisor_feature_setup_dns_server.sh`)

| Hostname                                    | Type | Value (IP Address) | Purpose                               |
| ------------------------------------------- | ---- | ------------------ | ------------------------------------- |
| `nginx.internal.thinkheads.ai`              | A    | `10.0.0.153`       | Entry point for all services          |
| `traefik.internal.thinkheads.ai`            | A    | `10.0.0.153`       | Access Traefik Dashboard via Gateway  |
| `ca.internal.thinkheads.ai`                 | A    | `10.0.0.153`       | Access Step-CA UI via Gateway         |
| `portainer.internal.thinkheads.ai`          | A    | `10.0.0.153`       | Access Portainer UI via Gateway       |
| `portainer-agent.internal.thinkheads.ai`    | A    | `10.0.0.153`       | Access Portainer Agent via Gateway    |
| `granite-embedding.internal.thinkheads.ai`  | A    | `10.0.0.153`       | Access Granite Embedding API          |
| `granite-3b.internal.thinkheads.ai`         | A    | `10.0.0.153`       | Access Granite 3B API                 |
| `ollama.internal.thinkheads.ai`             | A    | `10.0.0.153`       | Access Ollama API                     |
| `llamacpp.internal.thinkheads.ai`           | A    | `10.0.0.153`       | Access LlamaCPP API                   |

---

## 2. Firewall Configuration

The firewall operates on a **default DROP** policy, meaning all traffic is blocked unless explicitly allowed by a rule. Rules are applied at both the hypervisor (global) level and on a per-guest (VM/LXC) basis.

**Note on Stateful Inspection**: The Proxmox firewall is stateful. This means that if an `IN` rule allows an incoming connection, the return traffic for that same connection is automatically permitted. An explicit `OUT` rule is only required for initiating new, outbound connections.

### 2.1. Hypervisor Global Firewall Rules

**Location**: Proxmox Datacenter Firewall (Configured by `hypervisor_feature_setup_firewall.sh`)

| Direction | Action | Source IP       | Destination IP  | Protocol | Port(s) | Comment                                       |
| --------- | ------ | --------------- | --------------- | -------- | ------- | --------------------------------------------- |
| IN        | ACCEPT | `ANY`           | `10.0.0.153`    | `tcp`    | `80`    | Allow HTTP for ACME challenges to Nginx       |
| IN        | ACCEPT | `ANY`           | `10.0.0.153`    | `tcp`    | `443`   | Allow HTTPS for all services to Nginx         |
| IN        | ACCEPT | `10.0.0.0/24`   | `10.0.0.13`     | `udp`    | `53`    | Allow internal guests to query DNS on Host    |
| IN        | ACCEPT | `10.0.0.0/24`   | `10.0.0.13`     | `tcp`    | `53`    | Allow internal guests to query DNS on Host    |
| IN        | ACCEPT | `10.0.0.0/24`   | `10.0.0.13`     | `tcp`    | `2049`  | Allow internal guests to access NFS on Host   |
| OUT       | ACCEPT | `ANY`           | `ANY`           | `any`    | `ANY`   | Allow all outbound traffic from the hypervisor|

### 2.2. Guest-Specific Firewall Rules

#### LXC 101 (Nginx Gateway - `10.0.0.153`)
| Direction | Action | Source IP       | Destination IP  | Protocol | Port(s) | Comment                                       |
| --------- | ------ | --------------- | --------------- | -------- | ------- | --------------------------------------------- |
| OUT       | ACCEPT | `10.0.0.153`    | `10.0.0.12`     | `tcp`    | `80`    | **Allow Nginx to proxy to Traefik**           |
| OUT       | ACCEPT | `10.0.0.153`    | `10.0.0.10`     | `tcp`    | `9000`  | Allow Nginx to request certs from Step-CA   |

#### LXC 102 (Traefik Service Mesh - `10.0.0.12`)
| Direction | Action | Source IP       | Destination IP  | Protocol | Port(s) | Comment                                       |
| --------- | ------ | --------------- | --------------- | -------- | ------- | --------------------------------------------- |
| OUT       | ACCEPT | `10.0.0.12`     | `10.0.0.111`    | `tcp`    | `9443`  | Allow Traefik to route to Portainer Server    |
| OUT       | ACCEPT | `10.0.0.12`     | `10.0.0.102`    | `tcp`    | `9001`  | Allow Traefik to route to Portainer Agent     |
| OUT       | ACCEPT | `10.0.0.12`     | `10.0.0.141`    | `tcp`    | `8000`  | Allow Traefik to route to granite-embedding   |
| OUT       | ACCEPT | `10.0.0.12`     | `10.0.0.142`    | `tcp`    | `8000`  | Allow Traefik to route to granite-3b          |
| OUT       | ACCEPT | `10.0.0.12`     | `10.0.0.155`    | `tcp`    | `11434` | Allow Traefik to route to ollama              |
| OUT       | ACCEPT | `10.0.0.12`     | `10.0.0.157`    | `tcp`    | `8081`  | Allow Traefik to route to llamacpp            |

#### LXC 103 (Step-CA - `10.0.0.10`)
| Direction | Action | Source IP       | Destination IP  | Protocol | Port(s) | Comment                                       |
| --------- | ------ | --------------- | --------------- | -------- | ------- | --------------------------------------------- |
| OUT       | ACCEPT | `10.0.0.10`     | `10.0.0.153`    | `tcp`    | `80`    | **Allow CA to perform ACME validation**       |

#### VM 1001 (Portainer Server - `10.0.0.111`)
| Direction | Action | Source IP       | Destination IP  | Protocol | Port(s) | Comment                                       |
| --------- | ------ | --------------- | --------------- | -------- | ------- | --------------------------------------------- |
| OUT       | ACCEPT | `10.0.0.111`    | `10.0.0.102`    | `tcp`    | `9001`  | Allow Portainer Server to connect to Agent    |

#### VM 1002 (Portainer Agent - `10.0.0.102`)
*No specific outbound rules required beyond default access to DNS and the hypervisor.*

This specification provides a clear and comprehensive guide for the required network configuration. Every rule and record has a distinct purpose that contributes to the overall security and functionality of the system.
