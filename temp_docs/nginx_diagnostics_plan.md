# Nginx Gateway and Traefik Service Mesh Diagnostics Plan

This plan focuses on diagnosing the Nginx gateway and the Traefik service mesh. These two components work in tandem to route external and internal traffic to the correct services.

## 1. Verify Nginx Gateway (LXC 101) Configuration

Nginx is the entry point. We need to ensure it's correctly configured to proxy traffic to Traefik.

*   **Action:** Review the generated Nginx site configuration.
*   **Command:** `pct exec 101 -- cat /etc/nginx/sites-available/gateway`
*   **Verification:**
    *   Confirm that the `server_name` directive includes all expected external hostnames.
    *   Verify that the `ssl_certificate` and `ssl_certificate_key` paths are correct.
    *   Ensure that the `proxy_pass` directive is pointing to the Traefik container's IP and port (e.g., `http://10.0.0.12:80`).

*   **Action:** Check the Nginx service status and logs.
*   **Command:** `pct exec 101 -- systemctl status nginx`
*   **Command:** `pct exec 101 -- journalctl -u nginx -n 50`
*   **Verification:** The service should be active, and the logs should be free of errors, especially those related to SSL or upstream connection failures.

## 2. Verify Traefik Service Mesh (LXC 102) Configuration

Traefik handles the internal routing. Its dynamic configuration is generated by `phoenix sync all`, so we need to verify that it's correct.

*   **Action:** Review the static Traefik configuration.
*   **Command:** `pct exec 102 -- cat /etc/traefik/traefik.yml`
*   **Verification:**
    *   Ensure the `entryPoints` are correctly defined (e.g., `web` on port 80).
    *   Verify that the `providers.file.directory` is pointing to the correct path for dynamic configurations.

*   **Action:** Review the dynamically generated Traefik configuration.
*   **Command:** `pct exec 102 -- cat /etc/traefik/dynamic/dynamic_conf.yml`
*   **Verification:**
    *   This is a critical file. Confirm that it contains `[http.routers]` and `[http.services]` for all expected applications (Portainer, Portainer Agent, etc.).
    *   Check that the `service.loadBalancer.servers.url` for each service points to the correct IP and port of the target guest.

*   **Action:** Check the Traefik service status and logs.
*   **Command:** `pct exec 102 -- systemctl status traefik`
*   **Command:** `pct exec 102 -- journalctl -u traefik -n 50`
*   **Verification:** The service should be active, and the logs should be free of errors, especially those related to parsing configuration files or connecting to backend services.

## 3. End-to-End Routing Test

*   **Action:** From the hypervisor, make a `curl` request to an internal service, resolving the hostname to the Nginx gateway.
*   **Command:** `curl --resolve portainer.internal.thinkheads.ai:443:10.0.0.153 https://portainer.internal.thinkheads.ai --cacert /mnt/pve/quickOS/lxc-persistent-data/103/ssl/phoenix_root_ca.crt`
*   **Verification:** The command should return the HTML of the Portainer login page. A successful response here verifies that the entire chain (DNS -> Nginx -> Traefik -> Portainer) is working correctly.

## 4. Key Areas of Concern

*   **`proxy_pass` Mismatch:** If the Nginx `proxy_pass` directive is incorrect, traffic will never reach Traefik.
*   **Incorrect Dynamic Config:** Errors in the `dynamic_conf.yml` can cause Traefik to fail to load routes for services.
*   **Certificate Issues:** Even if the certificates are present, they might not be correctly referenced in the Nginx or Traefik configurations.