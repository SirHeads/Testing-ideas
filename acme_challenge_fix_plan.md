# ACME TLS-ALPN-01 Challenge Remediation Plan

## 1. Analysis of the Failure

The `phoenix sync all` command is now failing with a `500 Internal Server Error` when authenticating with Portainer. This indicates that the Nginx gateway is successfully routing traffic to Traefik, but Traefik itself is failing.

- **Root Cause**: The Traefik and Step-CA logs reveal that the ACME `tls-alpn-01` challenge is failing. This challenge is required for Traefik to obtain TLS certificates for the services it exposes.
- **Core Problem**: The `tls-alpn-01` challenge requires the ACME server (Step-CA) to perform a TLS handshake directly with the client requesting the certificate (Traefik). Our current architecture prevents this because the Nginx gateway (LXC 101) terminates the TLS connection. It decrypts all incoming HTTPS traffic and then forwards it to Traefik as plain HTTP. This breaks the ACME validation process.

## 2. Proposed Architectural Change: TCP Passthrough

The correct solution is to reconfigure Nginx to act as a pure TCP stream proxy for port 443. Instead of terminating the TLS connection, it will simply forward the encrypted traffic directly to Traefik. This allows Traefik to handle the TLS handshake, successfully complete the `tls-alpn-01` challenge, and manage all TLS certificates for the internal services.

This change simplifies the architecture and correctly assigns the responsibility of TLS termination to the internal service mesh (Traefik).

## 3. Proposed Implementation

To implement this, we will modify the Nginx configuration generator to create a `stream` block instead of an `http` server block for port 443.

**File to Modify**: `usr/local/phoenix_hypervisor/bin/generate_nginx_gateway_config.sh`

**Diff**:

```diff
<<<<<<< SEARCH
# --- Generate Unified Gateway Configuration (HTTP/HTTPS) ---
log_info "Generating unified configuration for TLS termination, ACME, and redirects..."
cat > "$GATEWAY_CONFIG_OUTPUT" <<EOF
# Generated by generate_nginx_gateway_config.sh (v8 - TLS Termination)

# This server block handles HTTP traffic on port 80.
# - It proxies ACME challenges to the internal Traefik service.
# - It redirects all other HTTP traffic to HTTPS.
server {
    listen 80;
    server_name _; # Catch-all for any hostname

    # Proxy ACME challenges to Traefik's http-01 challenge solver
    location /.well-known/acme-challenge/ {
        proxy_pass http://10.0.0.12:80;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }

    # Redirect all other traffic to the HTTPS equivalent
    location / {
        return 301 https://\$host\$request_uri;
    }
}

# This server block handles HTTPS traffic on port 443.
# - It terminates TLS using the certificate generated by Step-CA.
# - It proxies the decrypted traffic to Traefik's web entrypoint.
server {
    listen 443 ssl;
    server_name _; # Catch-all for any hostname

    ssl_certificate /etc/nginx/ssl/nginx.internal.thinkheads.ai.crt;
    ssl_certificate_key /etc/nginx/ssl/nginx.internal.thinkheads.ai.key;

    location / {
        proxy_pass https://10.0.0.12:8443;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
    }
}
EOF
log_success "Unified gateway configuration generated at ${GATEWAY_CONFIG_OUTPUT}"
=======
# --- Generate Unified Gateway Configuration (HTTP/HTTPS) ---
log_info "Generating unified configuration for TLS termination, ACME, and redirects..."
cat > "$GATEWAY_CONFIG_OUTPUT" <<EOF
# Generated by generate_nginx_gateway_config.sh (v9 - TCP Passthrough)

# This server block handles HTTP traffic on port 80.
# - It proxies ACME challenges to the internal Traefik service.
# - It redirects all other HTTP traffic to HTTPS.
server {
    listen 80;
    server_name _; # Catch-all for any hostname

    # Proxy ACME challenges to Traefik's http-01 challenge solver
    location /.well-known/acme-challenge/ {
        proxy_pass http://10.0.0.12:80;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }

    # Redirect all other traffic to the HTTPS equivalent
    location / {
        return 301 https://\$host\$request_uri;
    }
}
EOF
log_success "HTTP gateway configuration generated at ${GATEWAY_CONFIG_OUTPUT}"

# --- Generate Stream Configuration for TCP Passthrough ---
log_info "Generating stream configuration for TCP passthrough on port 443..."
mkdir -p "$(dirname "$STREAM_CONFIG_OUTPUT")"
cat > "$STREAM_CONFIG_OUTPUT" <<EOF
# Generated by generate_nginx_gateway_config.sh (v9 - TCP Passthrough)
# This server block handles TCP traffic on port 443 and forwards it to Traefik.
server {
    listen 443;
    proxy_pass 10.0.0.12:8443;
}
EOF
log_success "Stream configuration generated at ${STREAM_CONFIG_OUTPUT}"
>>>>>>> REPLACE
```

## 4. Verification

After applying the change, the following steps should be taken to verify the fix:

1.  Run the `phoenix sync all` command.
2.  Observe the logs to confirm that Traefik successfully obtains its certificates and that the Portainer API authentication succeeds without errors.
