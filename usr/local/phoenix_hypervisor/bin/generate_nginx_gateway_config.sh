#!/bin/bash
#
# File: generate_nginx_gateway_config.sh
# Description: This script dynamically generates the NGINX gateway configuration.
#              It creates a static configuration that proxies all requests to the
#              internal Traefik service mesh, aligning with the two-tiered proxy architecture.
#
# Version: 2.0.0 (Remediated)
# Author: Roo

# --- Determine script's absolute directory ---
SCRIPT_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" > /dev/null && pwd)
PHOENIX_BASE_DIR=$(cd "${SCRIPT_DIR}/.." > /dev/null && pwd)

# --- Source common utilities ---
source "${PHOENIX_BASE_DIR}/bin/phoenix_hypervisor_common_utils.sh"

# --- Configuration file paths ---
GATEWAY_CONFIG_OUTPUT="${PHOENIX_BASE_DIR}/etc/nginx/sites-available/gateway"
DOMAIN_NAME=$(get_global_config_value '.domain_name')
INTERNAL_DOMAIN_NAME="internal.thinkheads.ai"
TRAEFIK_INTERNAL_FQDN="traefik.${INTERNAL_DOMAIN_NAME}"

# --- Main execution ---
log_info "--- Starting NGINX Gateway Configuration Generation (v5 - Header Rewrite) ---"

# Dynamically generate map entries
map_entries=$(jq -n \
    --slurpfile vms "$VM_CONFIG_FILE" \
    --slurpfile lxcs "$LXC_CONFIG_FILE" \
    --arg domain "$DOMAIN_NAME" \
    --arg internal_domain "$INTERNAL_DOMAIN_NAME" \
    '
    [
        # Process all guests with a traefik_service definition
        ($vms[0].vms[]? | select(.traefik_service.name?)),
        ($lxcs[0].lxc_configs | values[]? | select(.traefik_service.name?))
    ]
    | .[] | .traefik_service as $service_def |
    "    \($service_def.name).\($domain) \($service_def.name).\($internal_domain);"
    ' | sed 's/"//g' # Remove quotes from the output
)

cat > "$GATEWAY_CONFIG_OUTPUT" <<EOF
# Generated by generate_nginx_gateway_config.sh (v5 - Header Rewrite)

# Map the public hostname to the internal hostname
map \$host \$internal_host {
    default \$host; # Default to passing the original host
${map_entries}
}

# HTTP to HTTPS Redirect
server {
    listen 80;
    server_name _;
    
    location /.well-known/acme-challenge/ {
        proxy_pass http://${TRAEFIK_INTERNAL_FQDN}:80;
        proxy_set_header Host \$host;
    }

    location / {
        return 301 https://\$host\$request_uri;
    }
}

# Main HTTPS Server Block
server {
    listen 443 ssl http2;
    server_name *.${DOMAIN_NAME};

    ssl_certificate /ssl/${DOMAIN_NAME}.crt;
    ssl_certificate_key /ssl/${DOMAIN_NAME}.key;
    proxy_ssl_trusted_certificate /ssl/phoenix_ca.crt;

    location / {
        # Proxy to the central Traefik mesh
        proxy_pass https://${TRAEFIK_INTERNAL_FQDN}:443;

        # Rewrite the Host header to the internal name
        proxy_set_header Host \$internal_host;
        
        # Standard proxy headers
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_ssl_server_name on;
    }
}
EOF

log_success "NGINX gateway configuration generated successfully at ${GATEWAY_CONFIG_OUTPUT}"