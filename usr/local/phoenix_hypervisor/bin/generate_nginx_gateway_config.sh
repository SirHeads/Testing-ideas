#!/bin/bash
#
# File: generate_nginx_gateway_config.sh
# Description: This script dynamically generates the NGINX gateway configuration.
#              It creates a static configuration that proxies all requests to the
#              internal Traefik service mesh, aligning with the two-tiered proxy architecture.
#
# Version: 2.0.0 (Remediated)
# Author: Roo

# --- Determine script's absolute directory ---
SCRIPT_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" > /dev/null && pwd)
PHOENIX_BASE_DIR=$(cd "${SCRIPT_DIR}/.." > /dev/null && pwd)

# --- Source common utilities ---
source "${PHOENIX_BASE_DIR}/bin/phoenix_hypervisor_common_utils.sh"

# --- Configuration file paths ---
GATEWAY_CONFIG_OUTPUT="${PHOENIX_BASE_DIR}/etc/nginx/sites-available/gateway"
STREAM_CONFIG_OUTPUT="${PHOENIX_BASE_DIR}/etc/nginx/stream.d/stream-gateway.conf"
DOMAIN_NAME=$(get_global_config_value '.domain_name')
INTERNAL_DOMAIN_NAME="internal.thinkheads.ai"
TRAEFIK_INTERNAL_FQDN="traefik.${INTERNAL_DOMAIN_NAME}"

# --- Main execution ---
log_info "--- Starting NGINX Gateway Configuration Generation (v8 - TLS Termination) ---"

# --- BEGIN: Dynamic Certificate Generation (Temporary Fix) ---
# This section ensures a valid certificate is in place for the gateway.
# The long-term solution is the centralized certificate-renewal-manager.sh

# Ensure the Step CLI is bootstrapped before trying to use it
source "${PHOENIX_BASE_DIR}/bin/hypervisor_setup/hypervisor_feature_bootstrap_step_cli.sh"

log_info "Ensuring TLS certificate for NGINX gateway is up-to-date..."
CERT_DIR="/mnt/pve/quickOS/lxc-persistent-data/101/ssl"
CERT_PATH="${CERT_DIR}/nginx.internal.thinkheads.ai.crt"
KEY_PATH="${CERT_DIR}/nginx.internal.thinkheads.ai.key"
mkdir -p "$CERT_DIR"

# Check if renewal is needed (expires in next 7 days, or doesn't exist)
RENEW_NEEDED=false
if [ ! -f "$CERT_PATH" ]; then
    RENEW_NEEDED=true
else
    if ! openssl x509 -in "$CERT_PATH" -checkend 604800 > /dev/null 2>&1; then
        RENEW_NEEDED=true
    fi
fi

if [ "$RENEW_NEEDED" = true ]; then
    log_info "Generating new TLS certificate for nginx.internal.thinkheads.ai..."
    provisioner_password_file="/mnt/pve/quickOS/lxc-persistent-data/103/ssl/provisioner_password.txt"
    if [ ! -f "$provisioner_password_file" ]; then
        log_fatal "Provisioner password file not found at: $provisioner_password_file"
    fi
    
    step ca certificate "nginx.internal.thinkheads.ai" "$CERT_PATH" "$KEY_PATH" \
        --provisioner admin@thinkheads.ai \
        --provisioner-password-file "$provisioner_password_file" \
        --not-after 24h --force
    
    if [ $? -eq 0 ]; then
        log_success "Successfully generated NGINX gateway TLS certificate."
        chown admin:admin "$CERT_PATH" "$KEY_PATH"
        chmod 644 "$CERT_PATH" "$KEY_PATH"
    else
        log_fatal "Failed to generate NGINX gateway TLS certificate."
    fi
else
    log_info "NGINX gateway certificate is current. No renewal needed."
fi
# --- END: Dynamic Certificate Generation ---

# Clean up the old stream configuration directory if it exists
if [ -d "$(dirname "$STREAM_CONFIG_OUTPUT")" ]; then
    rm -rf "$(dirname "$STREAM_CONFIG_OUTPUT")"
    log_info "Removed old stream configuration directory."
fi

# --- Generate Unified Gateway Configuration (HTTP/HTTPS) ---
# --- Generate Unified Gateway Configuration (HTTP/HTTPS) ---
log_info "Generating unified configuration for TLS termination, ACME, and redirects..."
cat > "$GATEWAY_CONFIG_OUTPUT" <<EOF
# Generated by generate_nginx_gateway_config.sh (v10 - TLS Termination)

server {
    listen 80;
    server_name _;

    location /.well-known/acme-challenge/ {
        proxy_pass http://10.0.0.12:80;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }

    location / {
        return 301 https://\$host\$request_uri;
    }
}

server {
    listen 443 ssl http2;
    server_name _;

    ssl_certificate /etc/nginx/ssl/nginx.internal.thinkheads.ai.crt;
    ssl_certificate_key /etc/nginx/ssl/nginx.internal.thinkheads.ai.key;

    location / {
        proxy_pass https://10.0.0.12:8443;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_set_header X-Forwarded-Host \$host;
        proxy_set_header X-Forwarded-Server \$host;
    }
}
EOF
log_success "Unified gateway configuration generated at ${GATEWAY_CONFIG_OUTPUT}"

# --- Remove Stream Configuration ---
log_info "Removing stream configuration as it is no longer needed."
if [ -f "$STREAM_CONFIG_OUTPUT" ]; then
    rm "$STREAM_CONFIG_OUTPUT"
fi