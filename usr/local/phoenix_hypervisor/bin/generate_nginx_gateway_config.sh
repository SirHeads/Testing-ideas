#!/bin/bash
#
# File: generate_nginx_gateway_config.sh
# Description: This script dynamically generates the NGINX gateway configuration.
#              It creates a static configuration that proxies all requests to the
#              internal Traefik service mesh, aligning with the two-tiered proxy architecture.
#
# Version: 2.0.0 (Remediated)
# Author: Roo

# --- Determine script's absolute directory ---
SCRIPT_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" > /dev/null && pwd)
PHOENIX_BASE_DIR=$(cd "${SCRIPT_DIR}/.." > /dev/null && pwd)

# --- Source common utilities ---
source "${PHOENIX_BASE_DIR}/bin/phoenix_hypervisor_common_utils.sh"

# --- Configuration file paths ---
GATEWAY_CONFIG_OUTPUT="${PHOENIX_BASE_DIR}/etc/nginx/sites-available/gateway"
STREAM_CONFIG_OUTPUT="${PHOENIX_BASE_DIR}/etc/nginx/stream.d/stream-gateway.conf"
DOMAIN_NAME=$(get_global_config_value '.domain_name')
INTERNAL_DOMAIN_NAME="internal.thinkheads.ai"
TRAEFIK_INTERNAL_FQDN="traefik.${INTERNAL_DOMAIN_NAME}"

# --- Main execution ---
log_info "--- Starting NGINX Gateway Configuration Generation (v8 - TLS Termination) ---"

# Clean up the old stream configuration directory if it exists
if [ -d "$(dirname "$STREAM_CONFIG_OUTPUT")" ]; then
    rm -rf "$(dirname "$STREAM_CONFIG_OUTPUT")"
    log_info "Removed old stream configuration directory."
fi

# --- Generate Unified Gateway Configuration (HTTP/HTTPS) ---
log_info "Generating unified configuration for TLS termination, ACME, and redirects..."
cat > "$GATEWAY_CONFIG_OUTPUT" <<EOF
# Generated by generate_nginx_gateway_config.sh (v8 - TLS Termination)

# This server block handles HTTP traffic on port 80.
# - It proxies ACME challenges to the internal Traefik service.
# - It redirects all other HTTP traffic to HTTPS.
server {
    listen 80;
    server_name _; # Catch-all for any hostname

    # Proxy ACME challenges to Traefik's http-01 challenge solver
    location /.well-known/acme-challenge/ {
        proxy_pass http://10.0.0.12:80;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }

    # Redirect all other traffic to the HTTPS equivalent
    location / {
        return 301 https://\$host\$request_uri;
    }
}

# This server block handles HTTPS traffic on port 443.
# - It terminates TLS using the certificate generated by Step-CA.
# - It proxies the decrypted traffic to Traefik's web entrypoint.
server {
    listen 443 ssl;
    server_name _; # Catch-all for any hostname

    ssl_certificate /etc/nginx/ssl/nginx.internal.thinkheads.ai.crt;
    ssl_certificate_key /etc/nginx/ssl/nginx.internal.thinkheads.ai.key;

    location / {
        proxy_pass https://10.0.0.12:8443;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
    }
}
EOF
log_success "Unified gateway configuration generated at ${GATEWAY_CONFIG_OUTPUT}"