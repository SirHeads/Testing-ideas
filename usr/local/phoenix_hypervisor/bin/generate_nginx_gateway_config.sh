#!/bin/bash
#
# File: generate_nginx_gateway_config.sh
# Description: This script dynamically generates the NGINX gateway configuration.
#              It creates a static configuration that proxies all requests to the
#              internal Traefik service mesh, aligning with the two-tiered proxy architecture.
#
# Version: 2.0.0 (Remediated)
# Author: Roo

# --- Determine script's absolute directory ---
SCRIPT_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &> /dev/null && pwd)
PHOENIX_BASE_DIR=$(cd "${SCRIPT_DIR}/.." &> /dev/null && pwd)

# --- Source common utilities ---
source "${PHOENIX_BASE_DIR}/bin/phoenix_hypervisor_common_utils.sh"

# --- Configuration file paths ---
GATEWAY_CONFIG_OUTPUT="${PHOENIX_BASE_DIR}/etc/nginx/sites-available/gateway"
STREAM_CONFIG_OUTPUT="${PHOENIX_BASE_DIR}/etc/nginx/stream.d/stream-gateway.conf"
DOMAIN_NAME=$(get_global_config_value '.domain_name')
INTERNAL_DOMAIN_NAME="internal.thinkheads.ai"
TRAEFIK_INTERNAL_FQDN="traefik.${INTERNAL_DOMAIN_NAME}"

# --- Main execution ---
log_info "--- Starting NGINX Gateway Configuration Generation (v8 - TLS Termination) ---"

# Clean up the old stream configuration directory if it exists
if [ -d "$(dirname "$STREAM_CONFIG_OUTPUT")" ]; then
    rm -rf "$(dirname "$STREAM_CONFIG_OUTPUT")"
    log_info "Removed old stream configuration directory."
fi

# --- Generate Unified Gateway Configuration (HTTP/HTTPS) ---
# --- Generate Unified Gateway Configuration (HTTP/HTTPS) ---
log_info "Generating unified configuration for TLS termination, ACME, and redirects..."
cat > "$GATEWAY_CONFIG_OUTPUT" <<EOF
# Generated by generate_nginx_gateway_config.sh (v10 - TLS Termination)

server {
    listen 80;
    server_name _;

    location /.well-known/acme-challenge/ {
        proxy_pass http://10.0.0.12:80;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }

    location / {
        return 301 https://\$host\$request_uri;
    }
}

server {
    listen 443 ssl http2;
    server_name nginx.internal.thinkheads.ai;

    ssl_certificate /etc/nginx/ssl/nginx.internal.thinkheads.ai.crt;
    ssl_certificate_key /etc/nginx/ssl/nginx.internal.thinkheads.ai.key;

    location / {
        proxy_pass https://10.0.0.12:8443;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
}

server {
    listen 443 ssl http2;
    server_name portainer.internal.thinkheads.ai;

    ssl_certificate /etc/nginx/ssl/portainer.internal.thinkheads.ai.crt;
    ssl_certificate_key /etc/nginx/ssl/portainer.internal.thinkheads.ai.key;

    location / {
        proxy_pass https://10.0.0.12:8443;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
}
EOF
log_success "Unified gateway configuration generated at ${GATEWAY_CONFIG_OUTPUT}"

# --- Remove Stream Configuration ---
log_info "Removing stream configuration as it is no longer needed."
if [ -f "$STREAM_CONFIG_OUTPUT" ]; then
    rm "$STREAM_CONFIG_OUTPUT"
fi