#!/bin/bash
#
# File: generate_nginx_gateway_config.sh
# Description: This script dynamically generates the NGINX gateway configuration.
#              It creates a static configuration that proxies all requests to the
#              internal Traefik service mesh, aligning with the two-tiered proxy architecture.
#
# Version: 2.0.0 (Remediated)
# Author: Roo

# --- Determine script's absolute directory ---
SCRIPT_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" > /dev/null && pwd)
PHOENIX_BASE_DIR=$(cd "${SCRIPT_DIR}/.." > /dev/null && pwd)

# --- Source common utilities ---
source "${PHOENIX_BASE_DIR}/bin/phoenix_hypervisor_common_utils.sh"

# --- Configuration file paths ---
GATEWAY_CONFIG_OUTPUT="${PHOENIX_BASE_DIR}/etc/nginx/sites-available/gateway"
STREAM_CONFIG_OUTPUT="${PHOENIX_BASE_DIR}/etc/nginx/stream.d/stream-gateway.conf"
DOMAIN_NAME=$(get_global_config_value '.domain_name')
INTERNAL_DOMAIN_NAME="internal.thinkheads.ai"
TRAEFIK_INTERNAL_FQDN="traefik.${INTERNAL_DOMAIN_NAME}"

# --- Main execution ---
log_info "--- Starting NGINX Gateway Configuration Generation (v7 - TCP Passthrough) ---"

# Ensure the target directory for the stream config exists on the host
mkdir -p "$(dirname "$STREAM_CONFIG_OUTPUT")"

# --- Generate HTTP Gateway Configuration (Port 80) ---
log_info "Generating HTTP configuration for ACME and redirects..."
cat > "$GATEWAY_CONFIG_OUTPUT" <<EOF
# Generated by generate_nginx_gateway_config.sh (v7 - TCP Passthrough)

# This configuration handles HTTP traffic on port 80.
# - It proxies ACME challenges to the internal Traefik service.
# - It redirects all other HTTP traffic to HTTPS.

server {
    listen 80;
    server_name _; # Catch-all for any hostname

    # Proxy ACME challenges to Traefik's http-01 challenge solver
    location /.well-known/acme-challenge/ {
        proxy_pass http://10.0.0.12:80;
        proxy_set_header Host \$host;
    }

    # Redirect all other traffic to the HTTPS equivalent
    location / {
        return 301 https://\$host\$request_uri;
    }
}
EOF
log_success "HTTP gateway configuration generated at ${GATEWAY_CONFIG_OUTPUT}"

# --- Generate TCP Stream Gateway Configuration (Port 443) ---
log_info "Generating TCP stream configuration for TLS passthrough..."
cat > "$STREAM_CONFIG_OUTPUT" <<EOF
# Generated by generate_nginx_gateway_config.sh (v7 - TCP Passthrough)

# This configuration handles raw TCP traffic on port 443.
# It passes the encrypted TLS stream directly to the Traefik service,
# allowing Traefik to handle TLS termination and certificate management.

server {
    listen 443;
    proxy_pass 10.0.0.12:8443;
}
EOF

log_success "TCP stream gateway configuration generated at ${STREAM_CONFIG_OUTPUT}"