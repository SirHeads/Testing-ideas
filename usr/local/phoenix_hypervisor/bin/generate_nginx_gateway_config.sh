#!/bin/bash
#
# File: generate_nginx_gateway_config.sh
# Description: This script dynamically generates the NGINX gateway configuration.
#              It creates a simplified, robust configuration that acts as the sole
#              TLS termination point and proxies all traffic to the internal Traefik service mesh.
#
# Version: 3.0.0 (Remediated)
# Author: Roo

# --- Determine script's absolute directory ---
SCRIPT_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &> /dev/null && pwd)
PHOENIX_BASE_DIR=$(cd "${SCRIPT_DIR}/.." &> /dev/null && pwd)

# --- Source common utilities ---
source "${PHOENIX_BASE_DIR}/bin/phoenix_hypervisor_common_utils.sh"

# --- Configuration file paths ---
GATEWAY_CONFIG_OUTPUT="${PHOENIX_BASE_DIR}/etc/nginx/sites-available/gateway"
DOMAIN_NAME=$(get_global_config_value '.domain_name')

# --- Main execution ---
log_info "--- Starting NGINX Gateway Configuration Generation (v3 - Simplified) ---"

log_info "Generating unified configuration for TLS termination, ACME, and proxying..."
cat > "$GATEWAY_CONFIG_OUTPUT" <<EOF
# Generated by generate_nginx_gateway_config.sh (v3 - Simplified)

# Server block to handle ACME http-01 challenges and redirect all other HTTP traffic to HTTPS.
server {
    listen 80;
    server_name _; # Catch-all for any hostname

    # Location for ACME challenges from Step-CA.
    # This is the only traffic served over HTTP.
    location /.well-known/acme-challenge/ {
        # The root is set to a directory where the certificate manager places validation tokens.
        root /var/www/html;
        allow all;
    }

    # Redirect all other HTTP traffic to HTTPS with a permanent 301 redirect.
    location / {
        return 301 https://\$host\$request_uri;
    }
}

# Main server block for all HTTPS traffic.
# This block acts as the single TLS termination point for the entire internal network.
server {
    listen 443 ssl http2;
    server_name *.$DOMAIN_NAME; # Wildcard server name to handle all internal services.

    # Use the centrally managed wildcard certificate.
    ssl_certificate /etc/nginx/ssl/wildcard.$DOMAIN_NAME.crt;
    ssl_certificate_key /etc/nginx/ssl/wildcard.$DOMAIN_NAME.key;

    # Proxy all requests to the Traefik service mesh over plain HTTP.
    location / {
        proxy_pass http://10.0.0.12:80;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
}
EOF

log_success "Unified gateway configuration generated at ${GATEWAY_CONFIG_OUTPUT}"
