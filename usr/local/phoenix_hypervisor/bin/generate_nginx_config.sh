#!/bin/bash
#
# File: generate_nginx_config.sh
# Description: This script dynamically generates the Nginx gateway configuration file.
#              It creates a unified server block for TLS termination and proxying to
#              the internal Traefik service mesh.
#
# Version: 1.0.0
# Author: Roo

# --- SCRIPT INITIALIZATION ---
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PHOENIX_BASE_DIR=$(cd "${SCRIPT_DIR}/.." &> /dev/null && pwd)
source "$SCRIPT_DIR/phoenix_hypervisor_common_utils.sh"

# --- CONFIGURATION ---
OUTPUT_FILE="${PHOENIX_BASE_DIR}/etc/nginx/sites-available/gateway"
DOMAIN_NAME=$(get_global_config_value '.domain_name')
TRAEFIK_IP="10.0.0.12" # The static IP of the Traefik container
TRAEFIK_PORT="80"

# --- MAIN LOGIC ---
main() {
    log_info "--- Starting NGINX Gateway Configuration Generation ---"

    # --- Certificate paths are relative to the Nginx container's filesystem ---
    local CERT_FILE="/etc/nginx/ssl/nginx.${DOMAIN_NAME}.crt"
    local KEY_FILE="/etc/nginx/ssl/nginx.${DOMAIN_NAME}.key"

    # --- GENERATE NGINX CONFIGURATION ---
    cat > "$OUTPUT_FILE" <<EOF
# Generated by generate_nginx_config.sh

# Server block to handle ACME http-01 challenges and redirect all other HTTP traffic to HTTPS.
server {
    listen 80;
    server_name _; # Catch-all for any hostname

    # Location for ACME challenges from Step-CA.
    location /.well-known/acme-challenge/ {
        root /var/www/html;
        allow all;
    }

    # Redirect all other HTTP traffic to HTTPS with a permanent 301 redirect.
    location / {
        return 301 https://\$host\$request_uri;
    }
}

# Main server block for all HTTPS traffic.
server {
    listen 443 ssl http2;
    server_name *.${DOMAIN_NAME}; # Handle all internal hostnames

    ssl_certificate ${CERT_FILE};
    ssl_certificate_key ${KEY_FILE};

    # Proxy all requests to the Traefik service mesh over plain HTTP.
    location / {
        proxy_pass http://${TRAEFIK_IP}:${TRAEFIK_PORT};
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
}
EOF

    log_success "Nginx gateway configuration generated successfully at ${OUTPUT_FILE}"
}

main