#!/bin/bash
#
# File: generate_nginx_config.sh
# Description: This script dynamically generates the Nginx gateway configuration file.
#              It creates a unified server block for TLS termination and proxying to
#              the internal Traefik service mesh.
#
# Version: 1.0.0
# Author: Roo

# --- SCRIPT INITIALIZATION ---
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PHOENIX_BASE_DIR=$(cd "${SCRIPT_DIR}/.." &> /dev/null && pwd)
source "$SCRIPT_DIR/phoenix_hypervisor_common_utils.sh"

# --- CONFIGURATION ---
OUTPUT_FILE="${PHOENIX_BASE_DIR}/etc/nginx/sites-available/gateway"
DOMAIN_NAME=$(get_global_config_value '.domain_name')
TRAEFIK_IP="10.0.0.12" # The static IP of the Traefik container
TRAEFIK_PORT="443" # Traefik is listening on 443 for HTTPS

# --- MAIN LOGIC ---
main() {
    log_info "--- Starting NGINX Gateway Configuration Generation ---"

    local CERT_FILE="/etc/nginx/ssl/nginx.${DOMAIN_NAME}.crt"
    local KEY_FILE="/etc/nginx/ssl/nginx.${DOMAIN_NAME}.key"
    local STACKS_CONFIG_FILE="${PHOENIX_BASE_DIR}/etc/phoenix_stacks_config.json"

    # Start with the base configuration (HTTP redirect and ACME challenge)
    cat > "$OUTPUT_FILE" <<EOF
# Generated by generate_nginx_config.sh

server {
    listen 80;
    server_name *.${DOMAIN_NAME};

    location /.well-known/acme-challenge/ {
        root /var/www/html;
        allow all;
    }

    location / {
        return 301 https://\$host\$request_uri;
    }
}
EOF

    # --- Dynamically generate server blocks for each service ---
    
    # Get hostnames from LXC, VM, and Stack configs
    local lxc_hosts=$(jq -r '.lxc_configs[].traefik_service.name' "$LXC_CONFIG_FILE" | sed "s/$/.${DOMAIN_NAME}/")
    local vm_hosts=$(jq -r '.vms[].traefik_service.name' "$VM_CONFIG_FILE" | sed "s/$/.${DOMAIN_NAME}/")
    local stack_hosts=$(jq -r '.docker_stacks[].nginx_proxy.hostname' "$STACKS_CONFIG_FILE")

    local all_hosts=$(echo -e "$lxc_hosts\n$vm_hosts\n$stack_hosts" | grep -v 'null' | sort -u)

    for host in $all_hosts; do
        log_info "Generating server block for host: ${host}"
        cat >> "$OUTPUT_FILE" <<EOF

# Server block for ${host}
server {
    listen 443 ssl http2;
    server_name ${host};

    ssl_certificate ${CERT_FILE};
    ssl_certificate_key ${KEY_FILE};

    location / {
        proxy_pass https://${TRAEFIK_IP}:${TRAEFIK_PORT};
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
}
EOF
    done

    log_success "Nginx gateway configuration generated successfully at ${OUTPUT_FILE}"
}

main