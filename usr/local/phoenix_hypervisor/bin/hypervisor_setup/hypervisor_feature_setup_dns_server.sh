#!/bin/bash
#
# File: hypervisor_feature_setup_dns_server.sh
# Description: This script sets up a dnsmasq server on the Proxmox host
#              to provide split-horizon DNS for the Phoenix Hypervisor environment.
#
# Version: 2.0.0
# Author: Roo

set -e

# --- SCRIPT INITIALIZATION ---
SCRIPT_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &> /dev/null && pwd)
PHOENIX_BASE_DIR=$(cd "${SCRIPT_DIR}/../.." &> /dev/null && pwd)

# Source common utilities
source "${PHOENIX_BASE_DIR}/bin/phoenix_hypervisor_common_utils.sh"

# =====================================================================================
# Function: setup_dns_server
# Description: Installs and configures dnsmasq based on the declarative configuration.
# =====================================================================================
setup_dns_server() {
    log_info "Starting dnsmasq server setup..."

    local LXC_CONFIG_FILE="${PHOENIX_BASE_DIR}/etc/phoenix_lxc_configs.json"
    local VM_CONFIG_FILE="${PHOENIX_BASE_DIR}/etc/phoenix_vm_configs.json"
    
    local DNS_CONFIG=$(get_global_config_value '.dns_server')

    if [ "$(echo "$DNS_CONFIG" | jq -r '.enabled')" != "true" ]; then
        log_info "DNS server setup is disabled in the configuration. Skipping."
        return
    fi

    log_info "Installing dnsmasq..."
    apt-get update > /dev/null
    apt-get install -y dnsmasq > /dev/null

    log_info "Configuring dnsmasq..."
    local DNSMASQ_CONF="/etc/dnsmasq.conf"
    local DNSMASQ_HOSTS_DIR="/etc/dnsmasq.d"

    # Create a backup of the original dnsmasq.conf
    [ -f "$DNSMASQ_CONF" ] && mv "$DNSMASQ_CONF" "${DNSMASQ_CONF}.bak.$(date +%s)"

    # Create a new dnsmasq.conf
    cat > "$DNSMASQ_CONF" <<EOF
# General dnsmasq settings
port=53
domain-needed
bogus-priv
strict-order

# Point to our custom hosts directory
conf-dir=${DNSMASQ_HOSTS_DIR},*.conf
EOF

    # Add upstream DNS servers
    echo "$DNS_CONFIG" | jq -r '.upstream_servers[]' | while read -r server; do
        echo "server=${server}" >> "$DNSMASQ_CONF"
    done

    # Create the hosts directory
    mkdir -p "$DNSMASQ_HOSTS_DIR"
    rm -f ${DNSMASQ_HOSTS_DIR}/*.conf

    # --- BEGIN UNIFIED AGGREGATION LOGIC ---
    log_info "Aggregating all DNS records..."

    # Create a single combined JSON object of all records
    local ALL_RECORDS_JSON=$(jq -n \
        --argjson hypervisor_config "$(cat "$HYPERVISOR_CONFIG_FILE")" \
        --slurpfile vms "$VM_CONFIG_FILE" \
        --slurpfile lxcs "$LXC_CONFIG_FILE" \
        '
        [
            # 1. Process hypervisor authoritative zones
            ($hypervisor_config.dns_server.authoritative_zones[]? | . as $zone | .records[]? | {
                "hostname": (.hostname + "." + $zone.zone_name),
                "ip": (.ip_internal // .ip_external)
            }),

            # 2. Process VM dns_records
            ($vms[0].vms[]? | .dns_records[]?),

            # 3. Process LXC dns_records
            ($lxcs[0].lxc_configs | values[]? | .dns_records[]?)

        ] | flatten | .[] | select(.hostname and .ip)
        '
    )

    # 4. Write aggregated records to dnsmasq config files
    log_info "Writing aggregated DNS records to dnsmasq configuration..."
    local HOSTS_FILE="${DNSMASQ_HOSTS_DIR}/00-phoenix-aggregated-hosts.conf"
    echo "# Auto-generated by phoenix-cli on $(date)" > "$HOSTS_FILE"
    
    echo "$ALL_RECORDS_JSON" | jq -r '. | "address=/\(.hostname)/\(.ip)"' | while read -r record_line; do
        echo "$record_line" >> "$HOSTS_FILE"
        log_info "  - $record_line"
    done

    # --- BEGIN VALIDATION ---
    if [ ! -s "$HOSTS_FILE" ] || [ $(grep -cv '^#' "$HOSTS_FILE") -eq 0 ]; then
        log_warn "Generated DNS config file is empty or contains no active records. Skipping dnsmasq restart to prevent service disruption."
        # Optionally, restore a backup or take other corrective actions here.
    else
        log_info "Restarting dnsmasq service..."
        systemctl restart dnsmasq
    fi
    # --- END VALIDATION ---
    systemctl enable dnsmasq

    log_success "dnsmasq server setup completed successfully."
}

# --- Main execution ---
setup_dns_server