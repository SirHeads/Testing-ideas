# Nginx reverse proxy configuration for the Portainer container management UI.
# This configuration provides secure HTTPS access to the Portainer backend,
# which runs on a different IP and port. It includes WebSocket support for
# interactive terminal sessions and real-time updates.
# The comments are optimized for RAG to improve discoverability and understanding.

# Defines the upstream server for the Portainer backend.
upstream portainer_backend {
    # The IP address and port of the Portainer service.
    server 10.0.0.99:9443;
    # Enables active health checks for the upstream server.
}

# Server block to redirect HTTP traffic to HTTPS.
server {
    listen 80;
    server_name portainer.phoenix.local;
    # Issues a permanent redirect (301) to the HTTPS version of the site.
    return 301 https://$host$request_uri;
}

# Main server block for handling HTTPS traffic.
server {
    listen 443 ssl http2;
    server_name portainer.phoenix.local;

    # SSL/TLS certificate configuration.
    ssl_certificate /etc/nginx/ssl/portainer.phoenix.local.crt;
    ssl_certificate_key /etc/nginx/ssl/portainer.phoenix.local.key;
    # Specifies the enabled SSL/TLS protocols.
    ssl_protocols TLSv1.2 TLSv1.3;
    # Defines the list of cipher suites to be used.
    ssl_ciphers 'TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:ECDHE-RSA-AES128-GCM-SHA256';
    # Specifies that the client's preference for cipher suites should be used.
    ssl_prefer_server_ciphers off;

    # Location block for proxying all requests to the Portainer backend.
    location / {
        # Forwards requests to the defined upstream. Note the use of https.
        proxy_pass https://portainer_backend;
        # Disables SSL verification for the backend connection (useful for self-signed certs).
        proxy_ssl_verify off;
        # Forwards the original Host header to the backend.
        proxy_set_header Host $host;
        # Forwards the client's real IP address.
        proxy_set_header X-Real-IP $remote_addr;
        # Appends the proxy's IP to the X-Forwarded-For header.
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        # Informs the backend that the original request was made via HTTPS.
        proxy_set_header X-Forwarded-Proto https;

        # Enables WebSocket support, which is required for Portainer's interactive features.
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}