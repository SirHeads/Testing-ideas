{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "title": "Phoenix Hypervisor LXC Configuration",
    "description": "Schema for validating Phoenix Hypervisor LXC container configurations.",
    "type": "object",
    "properties": {
        "$schema": {
            "type": "string",
            "description": "URI of the JSON Schema used to validate this document."
        },
        "nvidia_driver_version": {
            "type": "string",
            "description": "Expected NVIDIA driver version on the host."
        },
        "nvidia_repo_url": {
            "type": "string",
            "pattern": "^(https?|ftp):\\/\\/[^\\s\\/$.?#].[^\\s]*$",
            "description": "URL for the NVIDIA CUDA repository."
        },
        "nvidia_runfile_url": {
            "type": "string",
            "pattern": "^(https?|ftp):\\/\\/[^\\s\\/$.?#].[^\\s]*$",
            "description": "URL for the NVIDIA Driver runfile installer."
        },
        "lxc_configs": {
            "type": "object",
            "description": "A map of LXC container configurations, keyed by container ID.",
            "patternProperties": {
                "^[0-9]+$": {
                    "type": "object",
                    "properties": {
                        "start_at_boot": {
                            "type": "boolean",
                            "description": "Specifies whether the container should start at boot."
                        },
                        "boot_order": {
                            "type": "integer",
                            "minimum": 0,
                            "description": "The boot order priority for the container."
                        },
                        "boot_delay": {
                            "type": "integer",
                            "minimum": 0,
                            "description": "The delay in seconds before starting the next container in the boot order."
                        },
                        "name": {
                            "type": "string",
                            "minLength": 1,
                            "description": "The human-readable name for the LXC container"
                        },
                        "memory_mb": {
                            "type": "integer",
                            "minimum": 512,
                            "maximum": 131072,
                            "description": "The amount of RAM allocated to the container in megabytes. For AI workloads, values typically range from 2048-32768 MB depending on model size"
                        },
                        "swap_mb": {
                            "type": "integer",
                            "description": "The amount of swap allocated to the container in megabytes."
                        },
                        "cores": {
                            "type": "integer",
                            "minimum": 1,
                            "maximum": 32,
                            "description": "The number of CPU cores allocated to the container. For AI workloads, typically 2-8 cores are recommended"
                        },
                        "template": {
                            "type": "string",
                            "minLength": 1,
                            "description": "The path to the LXC template tarball used to create the container"
                        },
                        "storage_pool": {
                            "type": "string",
                            "minLength": 1,
                            "description": "The name of the Proxmox storage pool to use for the container's root filesystem"
                        },
                        "storage_size_gb": {
                            "type": "integer",
                            "minimum": 10,
                            "maximum": 1024,
                            "description": "The size of the container's root filesystem in gigabytes. For AI workloads, typically 64-256 GB recommended"
                        },
                        "network_config": {
                            "type": "object",
                            "properties": {
                                "name": {
                                    "type": "string",
                                    "minLength": 1,
                                    "maxLength": 15,
                                    "description": "Name of the network interface inside the container"
                                },
                                "bridge": {
                                    "type": "string",
                                    "minLength": 1,
                                    "description": "Proxmox bridge the container connects to"
                                },
                                "type": {
                                    "type": "string",
                                    "enum": [
                                        "bridge",
                                        "macvlan"
                                    ],
                                    "description": "Type of network interface"
                                },
                                "parent": {
                                    "type": "string",
                                    "description": "Parent interface for macvlan"
                                },
                                "hwaddr": {
                                    "type": "string",
                                    "pattern": "^([0-9a-fA-F]{2}:){5}[0-9a-fA-F]{2}$",
                                    "description": "MAC address for the interface (override)"
                                },
                                "ip": {
                                    "type": "string",
                                    "pattern": "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])/([0-9]|[1-2][0-9]|3[0-2])$",
                                    "description": "Static IP address with CIDR notation for container"
                                },
                                "gw": {
                                    "type": "string",
                                    "pattern": "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$",
                                    "description": "Gateway IP address for the container's network"
                                },
                                "nameserver": {
                                    "type": "string",
                                    "description": "Explicit nameserver IP override"
                                },
                                "nameservers": {
                                    "type": "string"
                                }
                            },
                            "required": [
                                "name",
                                "ip",
                                "gw"
                            ]
                        },
                        "features": {
                            "type": "array",
                            "items": {
                                "type": "string",
                                "enum": [
                                    "base_setup",
                                    "nvidia",
                                    "docker",
                                    "vllm",
                                    "portainer",
                                    "dns_server",
                                    "nat_gateway",
                                    "ollama",
                                    "python_api_service",
                                    "step_ca",
                                    "traefik",
                                    "trusted_ca"
                                ]
                            },
                            "description": "An array of feature scripts to apply to the container."
                        },
                        "mac_address": {
                            "type": "string",
                            "pattern": "^([0-9a-fA-F]{2}:){5}[0-9a-fA-F]{2}$",
                            "description": "MAC address for the container interface"
                        },
                        "gpu_assignment": {
                            "type": "string",
                            "pattern": "^(none|[0-9]+(, ?[0-9]+)*)$",
                            "description": "GPU assignment for container. Use 'none' for no GPU access, or comma-separated indices (e.g., '0,1') for multiple GPUs"
                        },
                        "portainer_role": {
                            "type": "string",
                            "enum": [
                                "server",
                                "agent",
                                "none",
                                "infrastructure"
                            ],
                            "description": "Role of the container within the Portainer management system"
                        },
                        "unprivileged": {
                            "type": "boolean",
                            "description": "Whether the container runs in unprivileged mode"
                        },
                        "vllm_engine_config": {
                            "type": "object",
                            "properties": {
                                "ModelConfig": {
                                    "type": "object",
                                    "properties": {
                                        "model": {
                                            "type": "string"
                                        },
                                        "trust_remote_code": {
                                            "type": "boolean"
                                        },
                                        "dtype": {
                                            "type": "string"
                                        },
                                        "max_model_len": {
                                            "type": "integer"
                                        }
                                    },
                                    "required": [
                                        "model",
                                        "trust_remote_code",
                                        "dtype",
                                        "max_model_len"
                                    ]
                                },
                                "CacheConfig": {
                                    "type": "object",
                                    "properties": {
                                        "quantization": {
                                            "type": "string"
                                        },
                                        "gpu_memory_utilization": {
                                            "type": "number"
                                        }
                                    },
                                    "required": [
                                        "quantization",
                                        "gpu_memory_utilization"
                                    ]
                                },
                                "ParallelConfig": {
                                    "type": "object",
                                    "properties": {
                                        "tensor_parallel_size": {
                                            "type": "integer"
                                        }
                                    },
                                    "required": [
                                        "tensor_parallel_size"
                                    ]
                                },
                                "ServerConfig": {
                                    "type": "object",
                                    "properties": {
                                        "host": {
                                            "type": "string"
                                        },
                                        "port": {
                                            "type": "integer"
                                        },
                                        "served_model_name": {
                                            "type": "string"
                                        }
                                    },
                                    "required": [
                                        "host",
                                        "port",
                                        "served_model_name"
                                    ]
                                }
                            },
                            "required": [
                                "ModelConfig",
                                "CacheConfig",
                                "ParallelConfig",
                                "ServerConfig"
                            ]
                        },
                        "template_snapshot_name": {
                            "type": "string",
                            "minLength": 1,
                            "description": "The name of the snapshot this template container should create."
                        },
                        "clone_from_ctid": {
                            "type": "string",
                            "pattern": "^[0-9]+$",
                            "description": "The Container ID of the template to clone from when creating this container."
                        },
                        "application_script": {
                            "type": "string",
                            "minLength": 1,
                            "description": "Optional script to run after all features are applied to launch a persistent service."
                        },
                        "pct_options": {
                            "type": "array",
                            "items": {
                                "type": "string"
                            },
                            "description": "Additional options for the pct command."
                        },
                        "lxc_options": {
                            "type": "array",
                            "items": {
                                "type": "string"
                            },
                            "description": "Additional lxc options for the container."
                        },
                        "ports": {
                            "type": "array",
                            "items": {
                                "type": "string",
                                "pattern": "^[0-9]+:[0-9]+$"
                            },
                            "description": "An array of port mappings in the format 'host:container'."
                        },
                        "health_check": {
                            "type": "object",
                            "properties": {
                                "command": {
                                    "type": "string"
                                },
                                "retries": {
                                    "type": "integer"
                                },
                                "interval": {
                                    "type": "integer"
                                }
                            },
                            "required": [
                                "command"
                            ]
                        },
                        "firewall": {
                            "type": "object",
                            "properties": {
                                "enabled": {
                                    "type": "boolean"
                                },
                                "rules": {
                                    "type": "array",
                                    "items": {
                                        "type": "object",
                                        "properties": {
                                            "type": {
                                                "type": "string",
                                                "enum": [
                                                    "in",
                                                    "out"
                                                ]
                                            },
                                            "action": {
                                                "type": "string",
                                                "enum": [
                                                    "ACCEPT",
                                                    "DROP",
                                                    "REJECT"
                                                ]
                                            },
                                            "source": {
                                                "type": "string"
                                            },
                                            "dest": {
                                                "type": "string"
                                            },
                                            "proto": {
                                                "type": "string",
                                                "enum": [
                                                    "tcp",
                                                    "udp"
                                                ]
                                            },
                                            "port": {
                                                "type": "string"
                                            }
                                        },
                                        "required": [
                                            "type",
                                            "action"
                                        ]
                                    }
                                }
                            },
                            "required": [
                                "enabled"
                            ]
                        },
                        "dependencies": {
                            "type": "array",
                            "items": {
                                "type": "string",
                                "pattern": "^[0-9]+$"
                            },
                            "description": "An array of CTIDs that this container depends on. The orchestrator will ensure these containers are running before starting this one."
                        },
                        "tests": {
                            "type": "object",
                            "patternProperties": {
                                "^[a-zA-Z0-9_-]+$": {
                                    "type": "array",
                                    "items": {
                                        "type": "object",
                                        "properties": {
                                            "name": {
                                                "type": "string"
                                            },
                                            "type": {
                                                "type": "string"
                                            },
                                            "path": {
                                                "type": "string"
                                            }
                                        },
                                        "required": [
                                            "name",
                                            "type",
                                            "path"
                                        ]
                                    }
                                }
                            }
                        },
                        "zfs_volumes": {
                            "type": "array",
                            "description": "A list of dedicated ZFS volumes to be created and mounted into the container.",
                            "items": {
                                "type": "object",
                                "properties": {
                                    "name": {
                                        "type": "string"
                                    },
                                    "pool": {
                                        "type": "string"
                                    },
                                    "size_gb": {
                                        "type": "integer",
                                        "minimum": 1
                                    },
                                    "mount_point": {
                                        "type": "string"
                                    }
                                },
                                "required": [
                                    "name",
                                    "pool",
                                    "size_gb",
                                    "mount_point"
                                ]
                            }
                        },
                        "mount_points": {
                            "type": "array",
                            "items": {
                                "type": "object",
                                "properties": {
                                    "host_path": {
                                        "type": "string"
                                    },
                                    "container_path": {
                                        "type": "string"
                                    }
                                },
                                "required": [
                                    "host_path",
                                    "container_path"
                                ]
                            }
                        },
                        "apparmor_profile": {
                            "type": "string",
                            "description": "The AppArmor profile to apply to the container. Use 'unconfined' for no profile."
                        },
                        "apparmor_manages_nesting": {
                            "type": "boolean",
                            "description": "If true, indicates the AppArmor profile handles nesting, and the orchestrator should not apply the 'nesting=1' feature flag."
                        },
                        "enable_lifecycle_snapshots": {
                            "type": "boolean",
                            "description": "If true, the orchestrator will create 'pre-configured' and 'final-form' snapshots during the create lifecycle."
                        },
                        "trigger_sync_on_completion": {
                            "type": "boolean",
                            "description": "If true, triggers a 'phoenix sync all' command after this LXC container is successfully created and started during the 'LetsGo' workflow."
                        }
                    },
                    "dns_records": {
                        "type": "array",
                        "description": "A list of DNS records to create for this LXC.",
                        "items": {
                            "type": "object",
                            "properties": {
                                "hostname": {
                                    "type": "string"
                                },
                                "ip": {
                                    "type": "string"
                                }
                            },
                            "required": [
                                "hostname",
                                "ip"
                            ]
                        }
                    },
                    "required": [
                        "name",
                        "memory_mb",
                        "cores",
                        "storage_pool",
                        "storage_size_gb",
                        "network_config",
                        "portainer_role",
                        "unprivileged",
                        "apparmor_profile",
                        "apparmor_manages_nesting"
                    ]
                }
            }
        }
    },
    "required": [
        "$schema",
        "nvidia_driver_version",
        "nvidia_repo_url",
        "nvidia_runfile_url",
        "lxc_configs"
    ]
}