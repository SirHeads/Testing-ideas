# Do not load this file. Rather, load /etc/apparmor.d/lxc-containers, which
# sources this file.

profile lxc-phoenix-nvidia-gpu flags=(attach_disconnected,mediate_deleted) {
  #include <tunables/global>
  #include <abstractions/lxc/container-base>
  #include <abstractions/lxc/start-container>

  # Allow necessary mounts for the container filesystem
  mount fstype=rpc_pipefs,
  mount fstype=cgroup,
  mount fstype=cgroup2,
  mount fstype=debugfs,
  mount fstype=proc,
  mount,
  mount options=(rw,nosuid,nodev,noexec,relatime) -> /sys/kernel/debug/,
  
  # Allow NVIDIA GPU device files
  allow /dev/nvidia* rwm,
  allow /dev/nvidia-uvm rwm,
  allow /dev/nvidia-uvm-tools rwm,
  allow /dev/nvidia-caps/* rwm,

  # Deny writes to /proc/sys/fs/binfmt_misc/register
  deny mount fstype=binfmt_misc,
}