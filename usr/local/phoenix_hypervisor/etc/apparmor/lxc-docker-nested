#include <tunables/global>

profile lxc_docker_nested flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/lxc/container-base>
  #include <abstractions/lxc/start-container>

  # Core capabilities for container operation
  capability sys_admin,
  capability sys_chroot,
  capability mknod,
  capability sys_nice,
  capability sys_resource,
  capability net_bind_service,
  capability net_raw,
  capability net_admin,
  capability mac_admin,
  capability net_broadcast,

  # Network access
  network inet stream,
  network inet6 stream,
  network inet dgram,
  network inet6 dgram,
  network bridge,

  # DNS resolution
  /etc/resolv.conf r,
  /etc/hosts r,
  /etc/nsswitch.conf r,

  # Allow access to networking libraries
  /lib/** mr,
  /usr/lib/** mr,

  # Shared storage mounts
  /mnt/shared/** rwm,
  /zfs/storage/** rwm,

  # Deny access to sensitive host devices
  audit deny /dev/.lxc/proc/** rw,
  audit deny /dev/.lxc/sys/** rw,

  # Standard system filesystem mounts
  mount fstype=proc -> /proc/,
  mount fstype=sysfs -> /sys/,
  mount fstype=cgroup -> /sys/fs/cgroup/**,
  mount fstype=cgroup2 -> /sys/fs/cgroup/**,
  mount fstype=tmpfs -> /run/**,
  mount fstype=devpts -> /dev/pts/**,
  mount fstype=mqueue -> /dev/mqueue/**,

  # Allow necessary mounts for nesting and storage
  mount fstype=bpf -> /sys/fs/bpf/**,
  mount fstype=securityfs -> /sys/kernel/security/**,
  /sys/kernel/security/apparmor/profiles r,
  mount fstype=tracefs -> /sys/kernel/tracing/**,
  mount fstype=zfs -> /zfs/storage/**,

  # Allow bind mounts for shared storage
  mount options=(rw,bind) -> /mnt/**,
  mount options=(rw,remount) -> /mnt/**,
  mount options=(rw,nosuid,nodev,noexec,relatime,bind) -> /mnt/**,

  # Deny binfmt_misc by default for security
  # To enable multi-architecture container support, comment out the following line
  # and uncomment the line after it.
  audit deny mount fstype=binfmt_misc,
  # mount fstype=binfmt_misc -> /proc/sys/fs/binfmt_misc/,

  # Read-only access to home directories
  /home/*/ r,

  # Docker-specific permissions
  /var/run/docker.sock rw,
  /var/lib/docker/** rwm,
}