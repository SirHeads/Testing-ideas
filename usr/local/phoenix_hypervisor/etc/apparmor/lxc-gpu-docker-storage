# Do not load this file. Rather, load /etc/apparmor.d/lxc-containers, which
# sources this file.

profile lxc-gpu-docker-storage flags=(attach_disconnected,mediate_deleted) {
  #include <tunables/global>
  #include <abstractions/lxc/container-base>
  #include <abstractions/lxc/start-container>

  # Allow necessary mounts for the container filesystem
  mount fstype=rpc_pipefs,
  mount fstype=cgroup,
  mount fstype=cgroup2,
  mount fstype=debugfs,
  mount fstype=proc,
  mount options=(rw,nosuid,nodev,noexec,relatime) -> /sys/kernel/debug/,

  # Allow NVIDIA GPU device files
  /dev/nvidia* rwm,
  /dev/nvidia-uvm rwm,
  /dev/nvidia-uvm-tools rwm,
  /dev/nvidia-caps/* rwm,

  # Allow Docker
  /var/lib/docker/ r,
  /var/lib/docker/** rwm,
  /run/docker.sock rw,

  # Allow shared storage
  /mnt/shared/** rwm,

  # Deny writes to /proc/sys/fs/binfmt_misc/register
  deny mount fstype=binfmt_misc
}